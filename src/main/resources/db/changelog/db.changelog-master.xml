<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- ===================== COURSES ===================== -->
    <changeSet id="courses-table" author="ari">
        <createTable tableName="courses">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true"
                             primaryKeyName="pk_courses"
                             nullable="false"/>
            </column>

            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="description" type="TEXT"/>

            <column name="creator" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ===================== MODULES ===================== -->
    <changeSet id="modules-table" author="ari">
        <createTable tableName="modules">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true"
                             primaryKeyName="pk_modules"
                             nullable="false"/>
            </column>

            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="course_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="modules"
                baseColumnNames="course_id"
                constraintName="fk_modules_course"
                referencedTableName="courses"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <!-- ===================== LESSONS ===================== -->
    <changeSet id="lessons-table" author="ari">
        <createTable tableName="lessons">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true"
                             primaryKeyName="pk_lessons"
                             nullable="false"/>
            </column>

            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="content" type="JSONB">
                <constraints nullable="false"/>
            </column>

            <column name="is_enriched" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="module_id" type="BIGINT"/>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="lessons"
                baseColumnNames="module_id"
                constraintName="fk_lessons_module"
                referencedTableName="modules"
                referencedColumnNames="id"
                onDelete="SET NULL"/>
    </changeSet>

    <!-- ===================== COURSE TAGS ===================== -->
    <changeSet id="course-tags-table" author="ari">
        <createTable tableName="course_tags">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true"
                             primaryKeyName="pk_course_tags"
                             nullable="false"/>
            </column>

            <column name="course_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="tag" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="course_tags"
                baseColumnNames="course_id"
                constraintName="fk_course_tags_course"
                referencedTableName="courses"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <createIndex indexName="idx_course_tags_course_tag"
                     tableName="course_tags">
            <column name="course_id"/>
            <column name="tag"/>
        </createIndex>
    </changeSet>

    <!-- ===================== USERS ===================== -->
    <changeSet id="users-table" author="ari">
        <createTable tableName="users">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true"
                             primaryKeyName="pk_users"
                             nullable="false"/>
            </column>

            <column name="username" type="VARCHAR(100)">
                <constraints nullable="false"
                             unique="true"
                             uniqueConstraintName="uk_users_username"/>
            </column>

            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="roles" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"
                    defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="increase-title-lengths-v2" author="ari">
        <validCheckSum>ANY</validCheckSum>
        <modifyDataType tableName="courses" columnName="title" newDataType="VARCHAR(1000)"/>
        <modifyDataType tableName="modules" columnName="title" newDataType="VARCHAR(1000)"/>
        <modifyDataType tableName="lessons" columnName="title" newDataType="VARCHAR(1000)"/>
        <modifyDataType tableName="users" columnName="password" newDataType="VARCHAR(512)"/>
        <modifyDataType tableName="users" columnName="roles" newDataType="VARCHAR(512)"/>
    </changeSet>
    <changeSet id="increase-course-creator-length" author="ari">
        <modifyDataType
                tableName="courses"
                columnName="creator"
                newDataType="TEXT"/>
    </changeSet>
    <changeSet id="courses-text-columns-v3" author="ari">
        <modifyDataType tableName="courses" columnName="title" newDataType="TEXT"/>
        <modifyDataType tableName="courses" columnName="creator" newDataType="TEXT"/>
        <modifyDataType tableName="courses" columnName="description" newDataType="TEXT"/>
    </changeSet>

    <include file="db/changelog/db.changelog-leaderboard.xml"/>
<!--    <include file="db/changelog/db.changelog-populateDb.xml"/>-->
</databaseChangeLog>
