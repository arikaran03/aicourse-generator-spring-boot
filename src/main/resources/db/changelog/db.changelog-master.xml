<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">


    <changeSet id="courses-table" author="ari">
        <createTable tableName="courses">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"
                             primaryKeyName="pk_courses"
                             nullable="false"/>
            </column>

            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="description" type="TEXT">
                <constraints nullable="true"/>
            </column>

            <!-- Auth0 sub (string id of the user) -->
            <column name="creator" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="modules-table" author="ari">
        <createTable tableName="modules">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"
                             primaryKeyName="pk_modules"
                             nullable="false"/>
            </column>

            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <!-- Reference to parent course -->
            <column name="course_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>

            </column>

            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>

            </column>
        </createTable>

        <!-- Foreign key: modules.course_id -> courses.id -->
        <addForeignKeyConstraint
                baseTableName="modules"
                baseColumnNames="course_id"
                constraintName="fk_modules_course"
                referencedTableName="courses"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="lessons-table" author="ari">
        <createTable tableName="lessons">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"
                             primaryKeyName="pk_lessons"
                             nullable="false"/>
            </column>

            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <!-- Flexible structured blocks -> JSONB -->
            <column name="content" type="JSONB">
                <constraints nullable="false"/>
            </column>

            <column name="is_enriched" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <!-- Reference to parent module -->
            <column name="module_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE" defaultValueDate="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="lessons"
                baseColumnNames="module_id"
                constraintName="fk_lessons_module"
                referencedTableName="modules"
                referencedColumnNames="id"
                onDelete="SET NULL"/>
    </changeSet>

    <changeSet id="course-tags-table" author="ari">
        <createTable tableName="course_tags">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"
                             primaryKeyName="pk_course_tags"
                             nullable="false"/>
            </column>

            <column name="course_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="tag" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="course_tags"
                baseColumnNames="course_id"
                constraintName="fk_course_tags_course"
                referencedTableName="courses"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <createIndex
                indexName="idx_course_tags_course_tag"
                tableName="course_tags">
            <column name="course_id"/>
            <column name="tag"/>
        </createIndex>
    </changeSet>



</databaseChangeLog>